name: Build & Publish

on:
    push:
        branches: [ 'main' ]
    workflow_dispatch:

permissions:
    contents: read
    pages: write
    id-token: write

jobs:
    publish:
        runs-on: ubuntu-latest

        environment:
            name: github-pages
            url: ${{ steps.deployment.outputs.page_url }}

        steps:
            -   name: Checkout
                uses: actions/checkout@v3

            -   name: Install node
                uses: actions/setup-node@v3
                with:
                    node-version: 16

            -   name: Install pnpm
                uses: pnpm/action-setup@v2

            -   name: Get pnpm cache dir
                id: pnpm-cache
                shell: bash
                run: echo "STORE_PATH=$(pnpm store path)" >> $GITHUB_OUTPUT

            -   name: Setup pnpm cache
                uses: actions/cache@v3
                with:
                    path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
                    key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
                    restore-keys: |
                        ${{ runner.os }}-pnpm-store-

            -   name: Install dependencies
                run: pnpm install

            -   name: Build
                run: pnpm run build

            -   name: Setup GitHub Pages
                uses: actions/configure-pages@v3

            -   name: Upload artifact
                uses: actions/upload-pages-artifact@v1
                with:
                    path: './dist'
            -   name: Deploy to GitHub Pages
                uses: actions/deploy-pages@v1
